#!/usr/bin/env python3
# /// script
# requires-python = ">=3.8"
# dependencies = [
#     "numpy",
#     "matplotlib",
#     "scipy",
# ]
# ///
import matplotlib.pyplot as plt
import numpy as np

FS = 16000  # Hz
ALIGN = True  # wyrównanie opóźnienia (±32 próbek)
MAX_LAG = 32
IGNORE_HEAD = 0  # ile próbek pominąć z przodu przy SNR
IGNORE_TAIL = 0  # ile z tyłu

# ======= TU WKLEJ SWOJE DANE (dokładnie 320 intów w każdej liście) =======
orig_samples = [
    0,
    160,
    292,
    376,
    404,
    382,
    327,
    260,
    204,
    170,
    162,
    172,
    188,
    199,
    196,
    183,
    167,
    162,
    179,
    221,
    282,
    347,
    394,
    401,
    354,
    252,
    108,
    -54,
    -208,
    -326,
    -391,
    -401,
    -366,
    -305,
    -240,
    -190,
    -165,
    -164,
    -177,
    -193,
    -200,
    -193,
    -177,
    -164,
    -165,
    -190,
    -240,
    -305,
    -366,
    -401,
    -391,
    -326,
    -208,
    -54,
    108,
    252,
    354,
    401,
    394,
    347,
    282,
    221,
    179,
    162,
    167,
    183,
    196,
    199,
    188,
    172,
    162,
    170,
    204,
    260,
    327,
    382,
    404,
    376,
    292,
    160,
    0,
    -160,
    -292,
    -376,
    -404,
    -382,
    -327,
    -260,
    -204,
    -170,
    -162,
    -172,
    -188,
    -199,
    -196,
    -183,
    -167,
    -162,
    -179,
    -221,
    -282,
    -347,
    -394,
    -401,
    -354,
    -252,
    -108,
    54,
    208,
    326,
    391,
    401,
    366,
    305,
    240,
    190,
    165,
    164,
    177,
    193,
    200,
    193,
    177,
    164,
    165,
    190,
    240,
    305,
    366,
    401,
    391,
    326,
    208,
    54,
    -108,
    -252,
    -354,
    -401,
    -394,
    -347,
    -282,
    -221,
    -179,
    -162,
    -167,
    -183,
    -196,
    -199,
    -188,
    -172,
    -162,
    -170,
    -204,
    -260,
    -327,
    -382,
    -404,
    -376,
    -292,
    -160,
    0,
    160,
    292,
    376,
    404,
    382,
    327,
    260,
    204,
    170,
    162,
    172,
    188,
    199,
    196,
    183,
    167,
    162,
    179,
    221,
    282,
    347,
    394,
    401,
    354,
    252,
    108,
    -54,
    -208,
    -326,
    -391,
    -401,
    -366,
    -305,
    -240,
    -190,
    -165,
    -164,
    -177,
    -193,
    -200,
    -193,
    -177,
    -164,
    -165,
    -190,
    -240,
    -305,
    -366,
    -401,
    -391,
    -326,
    -208,
    -54,
    108,
    252,
    354,
    401,
    394,
    347,
    282,
    221,
    179,
    162,
    167,
    183,
    196,
    199,
    188,
    172,
    162,
    170,
    204,
    260,
    327,
    382,
    404,
    376,
    292,
    160,
    0,
    -160,
    -292,
    -376,
    -404,
    -382,
    -327,
    -260,
    -204,
    -170,
    -162,
    -172,
    -188,
    -199,
    -196,
    -183,
    -167,
    -162,
    -179,
    -221,
    -282,
    -347,
    -394,
    -401,
    -354,
    -252,
    -108,
    54,
    208,
    326,
    391,
    401,
    366,
    305,
    240,
    190,
    165,
    164,
    177,
    193,
    200,
    193,
    177,
    164,
    165,
    190,
    240,
    305,
    366,
    401,
    391,
    326,
    208,
    54,
    -108,
    -252,
    -354,
    -401,
    -394,
    -347,
    -282,
    -221,
    -179,
    -162,
    -167,
    -183,
    -196,
    -199,
    -188,
    -172,
    -162,
    -170,
    -204,
    -260,
    -327,
    -382,
    -404,
    -376,
    -292,
    -160,
    # ... 320 próbek int16 przed kompresją ...
]
dec_samples = [
    0,
    -1,
    -1,
    0,
    0,
    -1,
    -1,
    0,
    -1,
    -1,
    0,
    2,
    0,
    -4,
    -4,
    -3,
    1,
    -3,
    0,
    -1,
    8,
    -13,
    -6,
    38,
    67,
    89,
    194,
    342,
    374,
    287,
    184,
    173,
    174,
    176,
    178,
    196,
    189,
    178,
    156,
    147,
    176,
    221,
    288,
    342,
    394,
    397,
    357,
    242,
    107,
    -52,
    -211,
    -336,
    -398,
    -403,
    -366,
    -309,
    -246,
    -193,
    -168,
    -173,
    -181,
    -190,
    -205,
    -201,
    -184,
    -174,
    -171,
    -199,
    -255,
    -319,
    -377,
    -418,
    -402,
    -335,
    -213,
    -60,
    97,
    250,
    349,
    390,
    377,
    340,
    278,
    223,
    179,
    157,
    166,
    188,
    200,
    201,
    190,
    163,
    161,
    171,
    201,
    255,
    326,
    382,
    409,
    374,
    289,
    148,
    1,
    -159,
    -281,
    -378,
    -400,
    -377,
    -326,
    -262,
    -202,
    -172,
    -163,
    -185,
    -194,
    -207,
    -192,
    -187,
    -169,
    -174,
    -185,
    -217,
    -275,
    -356,
    -402,
    -401,
    -354,
    -257,
    -115,
    40,
    200,
    323,
    388,
    400,
    363,
    301,
    237,
    185,
    167,
    170,
    183,
    198,
    205,
    196,
    174,
    168,
    171,
    183,
    239,
    316,
    369,
    400,
    382,
    315,
    209,
    60,
    -106,
    -263,
    -368,
    -416,
    -400,
    -356,
    -281,
    -221,
    -178,
    -164,
    -162,
    -176,
    -195,
    -210,
    -197,
    -170,
    -167,
    -180,
    -208,
    -259,
    -322,
    -386,
    -417,
    -374,
    -287,
    -164,
    1,
    168,
    299,
    381,
    402,
    373,
    323,
    258,
    209,
    172,
    169,
    176,
    197,
    204,
    194,
    180,
    162,
    155,
    178,
    220,
    286,
    347,
    396,
    399,
    351,
    241,
    105,
    -48,
    -208,
    -336,
    -401,
    -407,
    -364,
    -313,
    -243,
    -196,
    -171,
    -172,
    -180,
    -190,
    -202,
    -190,
    -174,
    -166,
    -157,
    -188,
    -239,
    -318,
    -372,
    -404,
    -394,
    -328,
    -213,
    -61,
    104,
    251,
    360,
    402,
    395,
    344,
    276,
    225,
    183,
    163,
    173,
    180,
    191,
    195,
    183,
    172,
    168,
    169,
    210,
    267,
    328,
    378,
    406,
    369,
    297,
    166,
    -1,
    -164,
    -300,
    -382,
    -405,
    -379,
    -320,
    -265,
    -207,
    -170,
    -168,
    -176,
    -186,
    -200,
    -193,
    -194,
    -171,
    -160,
    -184,
    -228,
    -287,
    -348,
    -398,
    -407,
    -360,
    -254,
    -114,
    46,
    206,
    332,
    392,
    405,
    369,
    310,
    241,
    187,
    170,
    170,
    177,
    198,
    204,
    196,
    176,
    165,
    160,
    185,
    237,
    307,
    371,
    405,
    393,
    324,
    206,
    43,
    -111,
    -254,
    -353,
    -401,
    # ... 320 próbek int16 po DEKODOWANIU (wynik kompresji) ...
]
# ========================================================================


def ensure_int16(arr, name):
    a = np.asarray(arr, dtype=np.int32)
    if a.size != 320:
        raise ValueError(f"{name}: oczekuję dokładnie 320 próbek, mam {a.size}.")
    # dopilnuj zakresu int16
    a = np.clip(a, -32768, 32767).astype(np.int16)
    return a


def align_by_xcorr(x, y, max_lag):
    # wyrównaj y do x – znajdź lag z maks. korelacją w zakresie ±max_lag
    best_lag = 0
    best_val = -1e300
    for L in range(-max_lag, max_lag + 1):
        if L >= 0:
            xw = x[L:]
            yw = y[: len(xw)]
        else:
            yw = y[-L:]
            xw = x[: len(yw)]
        if len(xw) < 16:
            continue
        v = float(np.dot(xw.astype(np.int32), yw.astype(np.int32)))
        if v > best_val:
            best_val = v
            best_lag = L
    # przytnij do wspólnej długości po wyrównaniu
    if best_lag >= 0:
        x_al = x[best_lag:]
        y_al = y[: len(x_al)]
    else:
        y_al = y[-best_lag:]
        x_al = x[: len(y_al)]
    return x_al, y_al, best_lag


def snr_db(x, y, ig_head=0, ig_tail=0):
    N = min(len(x), len(y))
    a = ig_head
    b = N - ig_tail
    if b <= a:
        return float("nan")
    xo = x[a:b].astype(np.int32)
    yo = y[a:b].astype(np.int32)
    sig = np.sum(xo.astype(np.float64) ** 2)
    err = np.sum((xo - yo).astype(np.float64) ** 2)
    sig = max(sig, 1e-12)
    err = max(err, 1e-12)
    return 10.0 * np.log10(sig / err)


def mag_spectrum_dbfs(x_i16, fs):
    x = x_i16.astype(np.float32) / 32768.0
    w = np.hanning(x.size).astype(np.float32)
    X = np.fft.rfft(x * w)
    mag = np.abs(X) / (x.size / 2.0)
    mag[mag == 0] = 1e-12
    db = 20.0 * np.log10(mag)
    f = np.fft.rfftfreq(x.size, 1.0 / fs)
    return f, db


def main():
    x = ensure_int16(orig_samples, "orig_samples")
    y = ensure_int16(dec_samples, "dec_samples")

    if ALIGN:
        x_al, y_al, lag = align_by_xcorr(x, y, MAX_LAG)
        print(
            f"[ALIGN] lag = {lag} próbek; porównuję {len(x_al)} próbek po przycięciu."
        )
    else:
        x_al, y_al = x, y

    snr = snr_db(x_al, y_al, IGNORE_HEAD, IGNORE_TAIL)
    print(f"SNR = {snr:.2f} dB  (ignore head={IGNORE_HEAD}, tail={IGNORE_TAIL})")

    f1, db1 = mag_spectrum_dbfs(x_al, FS)
    plt.figure()
    plt.plot(f1, db1)
    plt.title("Widmo ORYGINAŁ (Hann, 320 próbek)")
    plt.xlabel("Częstotliwość [Hz]")
    plt.ylabel("Amplituda [dBFS]")
    plt.xlim(0, FS / 2)
    plt.grid(True, which="both", linestyle=":")
    plt.tight_layout()
    plt.savefig("fft_orig.png", dpi=120)

    f2, db2 = mag_spectrum_dbfs(y_al, FS)
    plt.figure()
    plt.plot(f2, db2)
    plt.title("Widmo PO (Hann, 320 próbek)")
    plt.xlabel("Częstotliwość [Hz]")
    plt.ylabel("Amplituda [dBFS]")
    plt.xlim(0, FS / 2)
    plt.grid(True, which="both", linestyle=":")
    plt.tight_layout()
    plt.savefig("fft_dec.png", dpi=120)

    print("Zapisano: fft_orig.png, fft_dec.png")


if __name__ == "__main__":
    main()
